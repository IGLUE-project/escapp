<%- include ("../partials/_header.ejs") %>
<div role="main" class="main">
    <style>
        .flex-column {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
    </style>
    <h1>Busqueda en red</h1>
    <div style="display:grid; display: grid; grid-template-columns: 2fr 5fr; grid-template-rows: 1fr 7fr; grid-column-gap: 0px; grid-row-gap: 0px;">
        <div style="grid-column:2; grid-row:1;padding-top:2em;" >
            <input id="search" type="text" placeholder="Buscar...">
            <button>Buscar</button>
        </div>
        <div style="grid-column:1; grid-row:2;padding:1em;" id="filters">
            <div class="flex-column">
                <label class="label"> Antes de:</label>
                <input type="date" id="before"/>
            </div>
            <div class="flex-column">
                <label class="label"> Después de:</label>
                <input type="date" id="after"/>
            </div>

            <select id="language">
                <option value="">--Idiomabb--</option>
                <option value="es">Español</option>
                <option value="en">Inglés</option>
                <option value="sr">Serbio</option>
            </select>
        </div>
        <div style="grid-column:2; grid-row:2;margin-top:2em" class="Results flexBoxEscapeRooms"> Los resultados
        </div>
    </div>
</div>

<script>
    document.querySelector("button").addEventListener("click", async () => {
        const query = document.getElementById("search").value;
        const before = document.getElementById("before").value;
        const after = document.getElementById("after").value;
        const lang = document.getElementById("language").value;

        let url = `/network/query?query=${encodeURIComponent(query)}`;
        if (before) {
            url += `&before=${encodeURIComponent(before)}`;
        }
        if (after) {
            url += `&after=${encodeURIComponent(after)}`;
        }
        if (language) {
            url += `&lang=${encodeURIComponent(lang)}`;
        }

        const response = await fetch(url);
        const results = await response.text();
        const jsonResults = JSON.parse(results);
        let parsedResults = "";

        jsonResults.forEach((escapeRoom, i) => {
            const href = escapeRoom.url ? escapeRoom.url + "/escapeRooms/" + escapeRoom.id : "../escapeRooms/" + escapeRoom.id;
            const imageURL = "../images/puzzleorange.png";
            parsedResults += newEscapeRoom(href, imageURL, escapeRoom.title);
        });
        document.querySelector(".Results").innerHTML = parsedResults;
    });


    const newEscapeRoom = (href, imageURL, title) => {return `
                <a href="${href}%>" class="escapeRoomItemWrapper animated bounceIn" title=${title} style="animation-delay: 100ms;" >
                    <div class="escapeRoomItem">
                        <div class="erFoto" style="text-align: center">
                            <div class="bckgFoto" style="background-image: url( ${imageURL ? imageURL :  "../images/puzzleorange.png"})"></div>
                            <h2 class="escapeRoomTitle">${title}</h2>
                        </div>
                    </div>
                </a>
    `;}



</script>
