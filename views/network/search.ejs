<%- include ("../partials/_header.ejs") %>
<div role="main" class="main">
    <h1>Busqueda en red</h1>
    <div style="display:grid; display: grid; grid-template-columns: 2fr 5fr; grid-template-rows: 1fr 3fr; grid-column-gap: 0px; grid-row-gap: 0px;">
        <input id="search" type="text" style="grid-column:2; grid-row:1;" placeholder="Buscar...">
        <div style="grid-column:1; grid-row:2;" id="filters">
            <div>
                <label> Antes de:</label>
                <input type="date" id="before"/>
            </div>
            <div>
                <label> Despues de:</label>
                <input type="date" id="after"/>
            </div>

            <select id="language">
                <option value="">--Idioma--</option>
                <option value="es">Español</option>
                <option value="en">Inglés</option>
                <option value="sr">Serbio</option>
            </select>
        </div>
        <div style="grid-column:2; grid-row:2;" class="Results"> Los resultados
        </div>
    </div>
    <button>Buscar</button>
</div>

<script>
    document.querySelector("button").addEventListener("click", async () => {
        const query = document.getElementById("search").value;
        const before = document.getElementById("before").value;
        const after = document.getElementById("after").value;
        const lang = document.getElementById("language").value;

        let url = `/network/query?query=${encodeURIComponent(query)}`;
        if (before) {
            url += `&before=${encodeURIComponent(before)}`;
        }
        if (after) {
            url += `&after=${encodeURIComponent(after)}`;
        }
        if (language) {
            url += `&lang=${encodeURIComponent(lang)}`;
        }

        const response = await fetch(url);
        const results = await response.text();
        const jsonResults = JSON.parse(results);
        let parsedResults = "";
        jsonResults.forEach((escapeRoom, i) => {
            const href = `/network/escapeRoom/${escapeRoom.id}`;
            const attachment = escapeRoom.attachments && escapeRoom.attachments.length > 0 ? escapeRoom.attachments[0] : null;
            const url = attachment ? attachment.url : null;
            parsedResults += newEscapeRoom(href, url, escapeRoom.title);
        });
        document.querySelector(".Results").innerHTML = parsedResults;
    });



    const newEscapeRoom = (href, url, title) => {return `
                <a href="${href}%>" class="escapeRoomItemWrapper animated bounceIn" title=${title} style="animation-delay: 100ms;" >
                    <div class="escapeRoomItem">
                        <div class="erFoto" style="text-align: center">
                            <div class="bckgFoto" style="background-image: url( ${url ? url :  "../images/puzzleorange.png"})"></div>
                            <h2 class="escapeRoomTitle">${title}</h2>
                        </div>
                    </div>
                </a>
`;}
</script>
