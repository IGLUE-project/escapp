
<link rel="stylesheet" href="/stylesheets/vendor/dropzone.css">
<!-- Theme included stylesheets -->
<% include ../../partials/_header.ejs %>
<div class="main step-assets">
    <h2><%=i18n.escapeRoom.steps.assets.title%></h2>
    <p class="intro-paragraph">
        <%=i18n.escapeRoom.steps.assets.explanation%>
    </p>

    <form method='POST' id="assetsForm" action='/escapeRooms/<%= escapeRoom.id %>/uploadAssets' class="dropzone animated zoomIn" >
        <input type="file" name="file" style="display:none;"/>
    </form>
    <br/>
    <br/>
    <br/>
    <form method='POST' id="assetsForm" action='/escapeRooms/<%= escapeRoom.id %>/assets' >
        <div class="align-right flex-buttons">
            <input id="assets" name="assets" type="hidden" value=""/>
            <a href="/escapeRooms/<%= escapeRoom.id %>"><button class="progress-buttons" type="button" value="exit" id="exit" name="exit"><%=i18n.common.exit%></button></a>
            <button class="progress-buttons" type="submit" value="next" id="next" name="next"><%=i18n.common.next%></button>
            <button class="progress-buttons" type="submit" value="previous" id="previous" name="previous"><%=i18n.common.previous%></button>
        </div>
        <%- include('../../partials/_progress', {progress}) %>

    </form>
    <br/>
    <br/>
    <br/>
    <br/>
</div>

<% include ../../partials/_footer %>
<script src="/js/vendor/dropzone.js"></script>
<script>
    Dropzone.options.assetsForm = {
        "paramName": "assets", // The name that will be used to transfer the file
        "maxFilesize": 10, // MB
        "addRemoveLinks": true,
        "accept": function(file, done) {
            done();
        },
        "success": function(file, {id}) {
           file.id = id;
           console.log(file)
        },
        "removedfile": function(file) {
            fetch("/escapeRooms/<%=escapeRoom.id%>/deleteAssets/" + file.id + "?method=DELETE",
             {method: "POST"})
            .then(res=> {
                if (res.status === 200) {
                    res.json()
                     .then(msg => file.previewElement.remove())
                } else {
                    res.json()
                     .then(msg => {throw new Error(msg.msg)})
                }
            })
            .catch(err=> alert(err))
        },
        "dictDefaultMessage": "<%=i18n.escapeRoom.steps.assets.dictDefaultMessage%>",
        "dictFallbackMessage": "<%=i18n.escapeRoom.steps.assets.dictFallbackMessage%>",
        "dictFileTooBig": "<%=i18n.escapeRoom.steps.assets.dictFileTooBig%>",
        "dictInvalidFileTypedictResponseError": "<%=i18n.escapeRoom.steps.assets.dictInvalidFileTypedictResponseError%>",
        "dictCancelUpload": "<%=i18n.escapeRoom.steps.assets.dictCancelUpload%>",
        "dictUploadCanceled": "<%=i18n.escapeRoom.steps.assets.dictUploadCanceled%>",
        "dictCancelUploadConfirmation": "<%=i18n.escapeRoom.steps.assets.dictCancelUploadConfirmation%>",
        "dictRemoveFile": "delete",
        "dictRemoveFileConfirmation": "<%=i18n.escapeRoom.steps.assets.dictRemoveFileConfirmation%>",
        "dictMaxFilesExceeded": "<%=i18n.escapeRoom.steps.assets.dictMaxFilesExceeded%>"
    };


    $(function(){
        var assets = <%- JSON.stringify(assets) %>;
        var dropzone = $("#assetsForm").get(0).dropzone;
        for (let a of assets) {
            let mockFile = { name: a.name, id: a.id };
            dropzone.options.addedfile.call(dropzone, mockFile);
            if (a.mime.match("image")) {
                dropzone.options.thumbnail.call(dropzone, mockFile, a.url);           
            }
        }



    });
</script>


